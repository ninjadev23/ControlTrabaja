---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import NavbarPrivate from '../components/Dashboard/NavbarPrivate.jsx';
import ProfileManager from '../components/Dashboard/ProfileManager.jsx';

const token = Astro.cookies.get("access_token")?.value;

if (!token) {
    return Astro.redirect('/login');
}

let userData = null;

try {
    const API_URL = import.meta.env.PUBLIC_API_URL;
    const response = await fetch(`${API_URL}/api/profile`, {
        headers: {
            'Content-Type': 'application/json',
            'Cookie': `access_token=${token}`,
            credentials: 'include'
        }
    });

    if (response.ok) {
        userData = await response.json();
    } else {
        return Astro.redirect('/login');
    }
} catch (error) {
    console.error("Error fetching profile:", error);
}
---

<Layout title="Mi Perfil | ControlObra" bg="bg-gray-50">
    <NavbarPrivate client:load userEmail={userData?.email} />

    <main>
        {userData ? (
            <ProfileManager client:load initialUser={userData} />
        ) : (
            <div class="flex items-center justify-center h-screen">
                <p>Cargando perfil...</p>
            </div>
        )}
    </main>
</Layout>